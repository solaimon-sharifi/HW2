name: CI - Build and Run Docker Compose

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Secret scan (fail on obvious keys)
        run: |
          set -euo pipefail
          # Scan the working tree for common secret patterns (OpenAI sk-, GitHub ghp_, AWS AKIA)
          FOUND=$(git grep -I -n -E "sk-[A-Za-z0-9_\-]{20,}|ghp_[A-Za-z0-9_]{8,}|AKIA[0-9A-Z]{16}|AIza[0-9A-Za-z_\-]{35,}" || true)
          if [ -n "${FOUND}" ]; then
            echo "Potential secret(s) found:" >&2
            echo "${FOUND}" >&2
            exit 1
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create `.env` (from repo secrets when available)
        env:
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          PGADMIN_DEFAULT_EMAIL: ${{ secrets.PGADMIN_DEFAULT_EMAIL }}
          PGADMIN_DEFAULT_PASSWORD: ${{ secrets.PGADMIN_DEFAULT_PASSWORD }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
        run: |
          # Use secrets when provided, fall back to safe CI defaults
          POSTGRES_USER=${POSTGRES_USER:-ci_user}
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-ci_pass}
          POSTGRES_DB=${POSTGRES_DB:-ci_db}
          PGADMIN_DEFAULT_EMAIL=${PGADMIN_DEFAULT_EMAIL:-admin@example.com}
          PGADMIN_DEFAULT_PASSWORD=${PGADMIN_DEFAULT_PASSWORD:-pgadmin_pass}
          DB_HOST=${DB_HOST:-db}
          DB_PORT=${DB_PORT:-5432}
          DB_USER=${DB_USER:-ci_user}
          DB_PASSWORD=${DB_PASSWORD:-ci_pass}
          DB_NAME=${DB_NAME:-ci_db}

          cat > .env <<ENV
          POSTGRES_USER=${POSTGRES_USER}
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
          POSTGRES_DB=${POSTGRES_DB}
          PGADMIN_DEFAULT_EMAIL=${PGADMIN_DEFAULT_EMAIL}
          PGADMIN_DEFAULT_PASSWORD=${PGADMIN_DEFAULT_PASSWORD}
          DB_HOST=${DB_HOST}
          DB_PORT=${DB_PORT}
          DB_USER=${DB_USER}
          DB_PASSWORD=${DB_PASSWORD}
          DB_NAME=${DB_NAME}
          ENV

      - name: Build and start docker-compose
        run: |
          docker compose up --build -d

      - name: Wait for Postgres ready
        run: |
          for i in {1..60}; do
            docker compose exec -T db pg_isready -U "${POSTGRES_USER}" -d "${POSTGRES_DB}" && break || true
            echo "waiting for postgres..."
            sleep 2
          done

      - name: Run SQL steps script
        run: |
          chmod +x ./scripts/run_sql_steps.sh
          ./scripts/run_sql_steps.sh

      - name: Run API examples script (curl)
        run: |
          chmod +x ./scripts/run_api_examples.sh
          ./scripts/run_api_examples.sh

      - name: Run automated tests (pytest)
        run: |
          python -m pip install --upgrade pip
          pip install -r dev-requirements.txt
          pytest -q tests

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: sql-reports
          path: reports/

      - name: Tear down
        if: always()
        run: |
          docker compose down -v
