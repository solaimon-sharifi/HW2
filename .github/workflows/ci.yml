name: CI - Build and Run Docker Compose

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env for CI
        run: |
          cat > .env <<'ENV'
          POSTGRES_USER=ci_user
          POSTGRES_PASSWORD=ci_pass
          POSTGRES_DB=ci_db
          PGADMIN_DEFAULT_EMAIL=admin@example.com
          PGADMIN_DEFAULT_PASSWORD=pgadmin_pass
          DB_HOST=db
          DB_PORT=5432
          DB_USER=ci_user
          DB_PASSWORD=ci_pass
          DB_NAME=ci_db
          ENV

      - name: Build and start docker-compose
        run: |
          docker compose up --build -d

      - name: Wait for Postgres ready
        run: |
          for i in {1..60}; do
            docker compose exec -T db pg_isready -U "${POSTGRES_USER}" -d "${POSTGRES_DB}" && break || true
            echo "waiting for postgres..."
            sleep 2
          done

      - name: Run SQL steps script
        run: |
          chmod +x ./scripts/run_sql_steps.sh
          ./scripts/run_sql_steps.sh

      - name: Run API examples script (curl)
        run: |
          chmod +x ./scripts/run_api_examples.sh
          ./scripts/run_api_examples.sh

      - name: Run automated tests (pytest)
        run: |
          python -m pip install --upgrade pip
          pip install -r dev-requirements.txt
          pytest -q tests

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: sql-reports
          path: reports/

      - name: Tear down
        if: always()
        run: |
          docker compose down -v
